<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Interview Prep - IdentityMaster</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        background-color: #f5f5f5;
        padding-bottom: 40px;
      }

      /* HEADER / TOP BAR */
      header {
        background-color: #333;
        color: white;
        padding: 20px;
        width: 100%;
      }

      .header-content {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 20px;
      }


      .header-right {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .profile-nav {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .profile-picture {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        cursor: pointer;
      }

      .profile-nav p {
        cursor: pointer;
      }

      .settings-icon {
        font-size: 24px;
        cursor: pointer;
        color: white;
        transition: opacity 0.2s;
      }

      .settings-icon:hover {
        opacity: 0.8;
      }

      /* MAIN CONTAINER */
      .main-container {
        max-width: 1000px;
        margin: 30px auto;
        padding: 20px;
      }

      /* PAGE TITLE */
      .page-title {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 30px;
        font-size: 24px;
        font-weight: bold;
      }

      /* JOB DESCRIPTION CARD */
      .job-description-card {
        background: white;
        border: 1px solid black;
        font-family: "Courier New", Courier, monospace;
        margin-bottom: 30px;
        box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.1);
      }

      .card-header {
        padding: 12px 20px;
        border-bottom: 1px solid black;
        font-size: 14px;
        font-weight: bold;
        background-color: #f9f9f9;
      }

      .card-body {
        padding: 30px;
      }

      .job-input-label {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 15px;
        font-size: 14px;
        color: #555;
      }

      .job-description-textarea {
        width: 100%;
        min-height: 150px;
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-family: Arial, sans-serif;
        font-size: 14px;
        resize: vertical;
        margin-bottom: 20px;
      }

      .job-description-textarea:focus {
        outline: 2px solid #333;
      }

      .example-description {
        background-color: #f5f5f5;
        border: 1px dashed #ccc;
        padding: 15px;
        margin-bottom: 20px;
        font-size: 13px;
        line-height: 1.6;
        color: #666;
      }

      .start-button-container {
        text-align: center;
        margin-top: 20px;
      }

      button {
        background-color: #333;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 4px;
        cursor: pointer;
        font-family: inherit;
        font-size: 14px;
        transition: background 0.2s;
      }

      button:hover {
        background-color: #555;
      }

      button:disabled {
        background-color: #999;
        cursor: not-allowed;
      }

      /* INTERVIEW CHAT SECTION */
      .interview-chat-card {
        background: white;
        border: 1px solid black;
        font-family: "Courier New", Courier, monospace;
        display: none;
        box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.1);
      }

      .interview-chat-card.active {
        display: block;
      }

      .chat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 20px;
        border-bottom: 1px solid black;
        background-color: #f9f9f9;
      }

      .chat-header-left {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: bold;
        font-size: 14px;
      }

      .chat-header-right {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .end-session-btn {
        background-color: #d32f2f;
        padding: 6px 12px;
        font-size: 12px;
      }

      .end-session-btn:hover {
        background-color: #b71c1c;
      }

      .copy-icon {
        cursor: pointer;
        font-size: 16px;
        color: #666;
      }

      .copy-icon:hover {
        color: #333;
      }

      .chat-messages {
        padding: 20px;
        min-height: 400px;
        max-height: 500px;
        overflow-y: auto;
        background-color: #fafafa;
      }

      .message {
        margin-bottom: 20px;
        display: flex;
        gap: 12px;
      }

      .message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        background-color: #e0e0e0;
      }

      .message-content {
        flex: 1;
      }

      .message-sender {
        font-weight: bold;
        margin-bottom: 5px;
        font-size: 13px;
      }

      .message-text {
        font-size: 14px;
        line-height: 1.5;
        color: #333;
      }

      .message-time {
        font-size: 11px;
        color: #999;
        margin-top: 5px;
      }

      .ai-message .message-avatar {
        background-color: #2196f3;
        color: white;
      }

      .user-message .message-avatar {
        background-color: transparent;
        padding: 0;
        overflow: hidden;
      }
      
      .user-message .message-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .chat-input-area {
        padding: 20px;
        border-top: 1px solid #ccc;
        display: flex;
        gap: 10px;
        background-color: white;
      }

      .chat-input {
        flex: 1;
        padding: 10px 15px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-family: Arial, sans-serif;
        font-size: 14px;
      }

      .chat-input:focus {
        outline: 2px solid #333;
      }

      .send-button {
        padding: 10px 20px;
        white-space: nowrap;
      }

      /* FEEDBACK SECTION */
      .feedback-card {
        background: white;
        border: 1px solid black;
        font-family: "Courier New", Courier, monospace;
        display: none;
        box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.1);
        margin-top: 30px;
      }

      .feedback-card.active {
        display: block;
      }

      .feedback-body {
        padding: 30px;
      }

      .feedback-section {
        margin-bottom: 25px;
      }

      .feedback-section-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: bold;
        font-size: 14px;
        margin-bottom: 12px;
      }

      .rating-stars {
        display: flex;
        gap: 5px;
        margin: 8px 0;
      }

      .star {
        font-size: 20px;
        color: #ffd700;
      }

      .star.empty {
        color: #ddd;
      }

      .feedback-list {
        list-style: none;
        padding-left: 0;
      }

      .feedback-list li {
        margin-bottom: 8px;
        padding-left: 20px;
        position: relative;
        font-size: 13px;
        line-height: 1.5;
      }

      .feedback-list li::before {
        content: "‚Ä¢";
        position: absolute;
        left: 0;
        color: #333;
      }

      .feedback-actions {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #ccc;
      }

      .back-button-container {
        text-align: center;
        margin-top: 30px;
      }
    </style>
  </head>

  <body>
    <header>
      <div class="header-content">
        <h1 style="cursor: pointer;" onclick="location.href = 'dashboard.html'">IdentityMaster</h1>
        <div class="header-right">
          <span class="settings-icon" onclick="location.href = 'account_settings.html'">‚öôÔ∏è</span>
          <div class="profile-nav">
            <img
              src="https://content.presentermedia.com/files/clipart/00030000/30857/casual_guy_icon_bust_800_wht.jpg"
              class="profile-picture"
              alt="Profile"
              onclick="location.href = 'profile.html'"
            />
            <p onclick="location.href = 'profile.html'">Alex</p>
          </div>
        </div>
      </div>
    </header>

    <div class="main-container">
      <div class="page-title">
        <span>üé§</span>
        <span>Interview Prep</span>
      </div>

      <!-- Job Description Input Card -->
      <div class="job-description-card" id="jobDescriptionCard">
        <div class="card-header">JOB DESCRIPTION INPUT</div>
        <div class="card-body">
          <div class="job-input-label">
            <span>‚úèÔ∏è</span>
            <span>Describe the position you're interviewing for:</span>
          </div>
          <textarea
            class="job-description-textarea"
            id="jobDescriptionInput"
            placeholder="Enter job description here...&#10;&#10;Example:&#10;Company: Google&#10;Position: Software Engineering Intern&#10;Responsibilities: Backend development, API design, work with distributed systems..."
          ></textarea>
          <div class="example-description" id="exampleDescription">
            <strong>Example:</strong><br />
            Company: Google<br />
            Position: Software Engineering Intern<br />
            Responsibilities: Backend development, API design, work with
            distributed systems...
          </div>
          <div class="start-button-container">
            <button id="startInterviewBtn">Start Interview Session</button>
          </div>
        </div>
      </div>

      <!-- Interview Chat Card -->
      <div class="interview-chat-card" id="interviewChatCard">
        <div class="chat-header">
          <div class="chat-header-left">
            <span>ü§ñ</span>
            <span>AI INTERVIEW SIMULATOR</span>
          </div>
          <div class="chat-header-right">
            <span class="copy-icon" title="Copy session">üìã</span>
            <button class="end-session-btn" id="endSessionBtn">
              End Session
            </button>
          </div>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-area">
          <input
            type="text"
            class="chat-input"
            id="chatInput"
            placeholder="Type your response..."
          />
          <button class="send-button" id="sendMessageBtn">Send ‚Üí</button>
        </div>
      </div>

      <!-- Feedback Card -->
      <div class="feedback-card" id="feedbackCard">
        <div class="card-header">
          <span>üìä</span>
          <span>INTERVIEW FEEDBACK & SUMMARY</span>
        </div>
        <div class="feedback-body">
          <div class="feedback-section">
            <div class="feedback-section-title">Overall Performance:</div>
            <div class="rating-stars" id="ratingStars"></div>
            <span id="ratingText"></span>
          </div>

          <div class="feedback-section">
            <div class="feedback-section-title">
              <span>‚úÖ</span>
              <span>Strengths:</span>
            </div>
            <ul class="feedback-list" id="strengthsList"></ul>
          </div>

          <div class="feedback-section">
            <div class="feedback-section-title">
              <span>üí°</span>
              <span>Areas for Improvement:</span>
            </div>
            <ul class="feedback-list" id="improvementsList"></ul>
          </div>

          <div class="feedback-section">
            <div class="feedback-section-title">
              <span>üìù</span>
              <span>Recommended Actions:</span>
            </div>
            <ul class="feedback-list" id="actionsList"></ul>
          </div>

          <div class="feedback-actions">
            <button id="saveFeedbackBtn">Save Feedback</button>
            <button id="newSessionBtn">New Session</button>
          </div>
        </div>
      </div>

      <div class="back-button-container">
        <button onclick="location.href = 'dashboard.html'">
          Back to Dashboard
        </button>
      </div>
    </div>

    <script>
      // State management
      let interviewStarted = false;
      let interviewEnded = false;
      let messageCount = 0;
      let currentSessionId = null;

      // DOM Elements
      const jobDescriptionCard = document.getElementById("jobDescriptionCard");
      const jobDescriptionInput = document.getElementById("jobDescriptionInput");
      const exampleDescription = document.getElementById("exampleDescription");
      const startInterviewBtn = document.getElementById("startInterviewBtn");
      const interviewChatCard = document.getElementById("interviewChatCard");
      const chatMessages = document.getElementById("chatMessages");
      const chatInput = document.getElementById("chatInput");
      const sendMessageBtn = document.getElementById("sendMessageBtn");
      const endSessionBtn = document.getElementById("endSessionBtn");
      const feedbackCard = document.getElementById("feedbackCard");

      // Start interview - Task 5.5: Call POST /api/interview/start
      async function startInterview() {
        const jobDescriptionText = jobDescriptionInput.value.trim();
        if (!jobDescriptionText) {
          alert("Please enter a job description before starting the interview.");
          return;
        }

        // Parse job description
        const lines = jobDescriptionText.split('\n');
        let company = "";
        let position = "";
        let requirements = "";

        lines.forEach(line => {
          const lowerLine = line.toLowerCase().trim();
          if (lowerLine.startsWith("company:")) {
            company = line.split(":").slice(1).join(":").trim();
          } else if (lowerLine.startsWith("position:")) {
            position = line.split(":").slice(1).join(":").trim();
          } else if (lowerLine.startsWith("responsibilities:") || lowerLine.startsWith("requirements:")) {
            requirements = line.split(":").slice(1).join(":").trim();
          } else if (requirements === "" && line.trim()) {
            if (company && position) {
              requirements = (requirements ? requirements + "\n" : "") + line.trim();
            }
          }
        });

        // Fallback parsing
        if (!company || !position) {
          const firstLine = lines[0]?.trim();
          const secondLine = lines[1]?.trim();
          if (firstLine && secondLine) {
            if (!company) company = firstLine;
            if (!position) position = secondLine;
            if (!requirements) requirements = lines.slice(2).join('\n').trim();
          } else {
            company = "Unknown";
            position = "Unknown";
            requirements = jobDescriptionText;
          }
        }

        if (!requirements) {
          requirements = "Not specified";
        }

        // Show loading state
        startInterviewBtn.disabled = true;
        startInterviewBtn.textContent = "Starting...";

        try {
          // Call POST /api/interview/start
          const response = await fetch("http://localhost:5001/api/interview/start", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              company: company,
              position: position,
              requirements: requirements
            }),
          });

          const data = await response.json();

          if (data.status === "success") {
            currentSessionId = data.sessionId;
            interviewStarted = true;
            interviewEnded = false;
            messageCount = 0;

            // Hide job description card and show chat
            jobDescriptionCard.style.display = "none";
            interviewChatCard.classList.add("active");

            // Clear previous messages
            chatMessages.innerHTML = "";

            // Add first question from AI
            addAIMessage(data.question);

            // Focus on chat input
            chatInput.focus();
          } else {
            throw new Error(data.message || "Failed to start interview");
          }
        } catch (error) {
          console.error("Error starting interview:", error);
          // Task 6.1: Better error handling for specific cases
          let errorMessage = error.message || "An unexpected error occurred";
          
          // Check for API quota errors
          if (errorMessage.includes("429") || errorMessage.includes("quota") || errorMessage.includes("Quota exceeded")) {
            errorMessage = "AI service quota exceeded. The free tier limit has been reached. Please wait a moment and try again later, or check your Gemini API quota at https://ai.google.dev/";
          } else if (errorMessage.includes("Failed to fetch") || errorMessage.includes("network")) {
            errorMessage = "Network error: Unable to connect to the server. Please check if the backend is running on port 5001.";
          } else if (errorMessage.includes("Failed to parse AI response")) {
            errorMessage = "AI service error: The AI service returned an invalid response. This might be due to quota limits or service issues. Please try again later.";
          }
          
          alert(`Failed to start interview: ${errorMessage}`);
        } finally {
          startInterviewBtn.disabled = false;
          startInterviewBtn.textContent = "Start Interview Session";
        }
      }

      // Add AI message to chat
      function addAIMessage(text) {
        const messageDiv = document.createElement("div");
        messageDiv.className = "message ai-message";
        const timeAgo = getTimeAgo();
        messageDiv.innerHTML = `
          <div class="message-avatar">ü§ñ</div>
          <div class="message-content">
            <div class="message-sender">AI Interviewer:</div>
            <div class="message-text">${text}</div>
            <div class="message-time">${timeAgo}</div>
          </div>
        `;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // Add user message to chat
      function addUserMessage(text) {
        const messageDiv = document.createElement("div");
        messageDiv.className = "message user-message";
        const timeAgo = getTimeAgo();
        messageDiv.innerHTML = `
          <div class="message-avatar">
            <img src="https://content.presentermedia.com/files/clipart/00030000/30857/casual_guy_icon_bust_800_wht.jpg" alt="User avatar" />
          </div>
          <div class="message-content">
            <div class="message-sender">You:</div>
            <div class="message-text">${text}</div>
            <div class="message-time">${timeAgo}</div>
          </div>
        `;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // Get time ago string
      function getTimeAgo() {
        messageCount++;
        if (messageCount === 1) return "2 min ago";
        if (messageCount === 2) return "1 min ago";
        return "Just now";
      }

      // Send user message - Task 5.6: Call POST /api/interview/message
      async function sendMessage() {
        const message = chatInput.value.trim();
        if (!message || !interviewStarted || interviewEnded) return;

        if (!currentSessionId) {
          alert("Session not found. Please start a new interview.");
          return;
        }

        addUserMessage(message);
        chatInput.value = "";
        chatInput.disabled = true;
        sendMessageBtn.disabled = true;
        sendMessageBtn.textContent = "Processing...";

        try {
          // Call POST /api/interview/message
          const response = await fetch("http://localhost:5001/api/interview/message", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              sessionId: currentSessionId,
              userResponse: message
            }),
          });

          const data = await response.json();

          if (data.status === "success") {
            // Add AI's next question
            addAIMessage(data.question);
            messageCount++;
          } else {
            throw new Error(data.message || "Failed to get next question");
          }
        } catch (error) {
          console.error("Error sending message:", error);
          addAIMessage(`I apologize, but I encountered an error processing your response. Please try again or end the session.`);
        } finally {
          chatInput.disabled = false;
          sendMessageBtn.disabled = false;
          sendMessageBtn.textContent = "Send ‚Üí";
          chatInput.focus();
        }
      }

      // End interview session - Task 5.7: Call POST /api/interview/end
      async function endSession() {
        if (!interviewStarted) return;

        if (
          confirm(
            "Are you sure you want to end the interview session? You will receive feedback based on your responses."
          )
        ) {
          if (!currentSessionId) {
            alert("Session not found. Please start a new interview.");
            return;
          }

          interviewEnded = true;
          chatInput.disabled = true;
          sendMessageBtn.disabled = true;
          endSessionBtn.disabled = true;
          endSessionBtn.textContent = "Processing...";

          try {
            // Call POST /api/interview/end
            const response = await fetch("http://localhost:5001/api/interview/end", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                sessionId: currentSessionId
              }),
            });

            const data = await response.json();

            if (data.status === "success" && data.feedback) {
              interviewChatCard.classList.remove("active");
              showFeedback(data.feedback);
            } else {
              throw new Error(data.message || "Failed to get feedback");
            }
          } catch (error) {
            console.error("Error ending session:", error);
            alert(`Failed to end interview: ${error.message}. Please try again.`);
            interviewEnded = false;
            chatInput.disabled = false;
            sendMessageBtn.disabled = false;
            endSessionBtn.disabled = false;
            endSessionBtn.textContent = "End Session";
          }
        }
      }

      // Show feedback card - Task 5.7: Display real feedback from API
      function showFeedback(feedbackData) {
        feedbackCard.classList.add("active");

        if (!feedbackData) {
          // Fallback to sample feedback if no data provided
          feedbackData = {
            overallScore: 4,
            strengths: ["Strong technical foundation", "Good communication"],
            areasForImprovement: ["Could elaborate more", "Practice STAR method"],
            recommendations: ["Review concepts", "Prepare examples"]
          };
        }

        const rating = Math.round(feedbackData.overallScore || 0);
        const ratingStarsHtml = Array(5)
          .fill(0)
          .map((_, i) => {
            if (i < rating) {
              return '<span class="star">‚òÖ</span>';
            } else {
              return '<span class="star empty">‚òÜ</span>';
            }
          })
          .join("");

        document.getElementById("ratingStars").innerHTML = ratingStarsHtml;
        document.getElementById("ratingText").textContent = `(${feedbackData.overallScore?.toFixed(1) || rating}/5)`;

        // Display strengths
        const strengthsList = document.getElementById("strengthsList");
        if (strengthsList && feedbackData.strengths && feedbackData.strengths.length > 0) {
          strengthsList.innerHTML = feedbackData.strengths.map(strength => `<li>${strength}</li>`).join("");
        } else if (strengthsList) {
          strengthsList.innerHTML = "<li>No specific strengths identified</li>";
        }

        // Display areas for improvement
        const improvementsList = document.getElementById("improvementsList");
        if (improvementsList && feedbackData.areasForImprovement && feedbackData.areasForImprovement.length > 0) {
          improvementsList.innerHTML = feedbackData.areasForImprovement.map(area => `<li>${area}</li>`).join("");
        } else if (improvementsList) {
          improvementsList.innerHTML = "<li>No specific areas for improvement identified</li>";
        }

        // Display recommendations
        const actionsList = document.getElementById("actionsList");
        if (actionsList && feedbackData.recommendations && feedbackData.recommendations.length > 0) {
          actionsList.innerHTML = feedbackData.recommendations.map(rec => `<li>${rec}</li>`).join("");
        } else if (actionsList) {
          actionsList.innerHTML = "<li>No specific recommendations</li>";
        }

        // Display breakdown if available
        if (feedbackData.breakdown) {
          const breakdown = feedbackData.breakdown;
          // You can add breakdown display here if needed
          console.log("Score breakdown:", breakdown);
        }
      }

      // Save feedback
      function saveFeedback() {
        alert("Feedback saved! You can view it in your dashboard.");
      }

      // Start new session
      function newSession() {
        interviewStarted = false;
        interviewEnded = false;
        messageCount = 0;
        currentSessionId = null;
        jobDescriptionInput.value = "";
        jobDescriptionCard.style.display = "block";
        interviewChatCard.classList.remove("active");
        feedbackCard.classList.remove("active");
        chatMessages.innerHTML = "";
        chatInput.disabled = false;
        sendMessageBtn.disabled = false;
        endSessionBtn.disabled = false;
        endSessionBtn.textContent = "End Session";
        jobDescriptionInput.focus();
      }

      // Event listeners
      startInterviewBtn.addEventListener("click", startInterview);

      sendMessageBtn.addEventListener("click", sendMessage);
      chatInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      endSessionBtn.addEventListener("click", endSession);
      document.getElementById("saveFeedbackBtn").addEventListener("click", saveFeedback);
      document.getElementById("newSessionBtn").addEventListener("click", newSession);

      // Copy session functionality
      document.querySelector(".copy-icon").addEventListener("click", () => {
        const messages = Array.from(chatMessages.querySelectorAll(".message-text")).map(
          (el) => el.textContent
        );
        const sessionText = messages.join("\n\n");
        navigator.clipboard.writeText(sessionText).then(() => {
          const copyIcon = document.querySelector(".copy-icon");
          const original = copyIcon.textContent;
          copyIcon.textContent = "‚úì";
          setTimeout(() => {
            copyIcon.textContent = original;
          }, 1000);
        });
      });

      // Hide example when user starts typing
      jobDescriptionInput.addEventListener("input", () => {
        if (jobDescriptionInput.value.trim()) {
          exampleDescription.style.display = "none";
        } else {
          exampleDescription.style.display = "block";
        }
      });
    </script>
  </body>
</html>